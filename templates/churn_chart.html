<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>流失顧客清單</title>
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; padding: 20px; }
      .container { max-width: 1000px; margin: 0 auto; }
      table { width: 100%; border-collapse: collapse; margin-top: 12px; }
      th, td { border: 1px solid #e5e7eb; padding: 8px 10px; text-align: left; }
      th { background: #f8fafc; }
      .muted { color: #6b7280; }
      .tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: #fff; }
      .tag-high { background: #dc3545; }
      .tag-medium { background: #f59e0b; }
      .tag-low { background: #16a34a; }
      .controls { display: flex; gap: 12px; align-items: center; }
      input[type="number"] { width: 100px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>流失顧客清單</h1>
      <p class="muted">資料來源：伺服器端 <code>/churn/</code> API。僅顯示機率大於等於門檻的顧客。</p>

      <div class="controls">
        <button id="reload">重新載入</button>
        <span id="status" class="muted"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th>Customer ID</th>
            <th>流失機率</th>
            <th>風險等級</th>
            <th>Recency(天)</th>
            <th>Frequency</th>
            <th>Monetary</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>

    <script>
    async function loadAndRender() {
      const status = document.getElementById('status');
      const tbody = document.getElementById('list');
      status.textContent = '載入資料中...';
      tbody.innerHTML = '';

      try {
        // 允許將頁面 query string 透傳給 API
        const params = new URLSearchParams(window.location.search);
        const res = await fetch('/churn/?' + params.toString());
        if (!res.ok) throw new Error('API 錯誤 ' + res.status);
        const body = await res.json();

        let rows = body.results || [];
        rows.sort((a, b) => Number(b.probability) - Number(a.probability));

        if (rows.length === 0) {
          status.textContent = '沒有可顯示的顧客資料。';
          return;
        }

        for (const r of rows) {
          const tr = document.createElement('tr');
          const tagClass = r.risk_level === 'high' ? 'tag-high' : (r.risk_level === 'medium' ? 'tag-medium' : 'tag-low');
          tr.innerHTML = `
            <td>${String(r.customerid)}</td>
            <td>${Number(r.probability).toFixed(3)}</td>
            <td><span class="tag ${tagClass}">${r.risk_level}</span></td>
            <td>${Number(r.recency_days)}</td>
            <td>${Number(r.frequency)}</td>
            <td>${Number(r.monetary).toFixed(0)}</td>
          `;
          tbody.appendChild(tr);
        }

        status.textContent = `顯示全部 ${rows.length} 位顧客。`;
      } catch (err) {
        status.textContent = '載入失敗：' + err.message;
        console.error(err);
      }
    }

    document.getElementById('reload').addEventListener('click', loadAndRender);
    loadAndRender();
    </script>
  </body>
  </html>
