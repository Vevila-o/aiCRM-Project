<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>流失顧客預測分析</title>
    <style>
      body { 
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; 
        padding: 20px; 
        background-color: #f8f9fa;
        margin: 0;
      }
      .container { max-width: 1400px; margin: 0 auto; }
      
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .header h1 {
        color: #333;
        margin: 0;
        font-size: 28px;
      }
      
      .header .subtitle {
        color: #666;
        margin: 5px 0 0 0;
        font-size: 14px;
      }
      
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        margin-left: 10px;
      }
      
      .btn-primary { background-color: #007bff; color: white; }
      .btn-primary:hover { background-color: #0056b3; }
      
      .btn-success { background-color: #28a745; color: white; }
      .btn-success:hover { background-color: #218838; }
      
      .btn-secondary { background-color: #6c757d; color: white; }
      .btn-secondary:hover { background-color: #5a6268; }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        transition: transform 0.3s, box-shadow 0.3s;
        border-left: 4px solid;
      }
      
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 25px rgba(0,0,0,0.12);
      }
      
      .stat-card.high { border-left-color: #dc3545; }
      .stat-card.medium { border-left-color: #ffc107; }
      .stat-card.low { border-left-color: #28a745; }
      .stat-card.total { border-left-color: #17a2b8; }
      
      .stat-card h3 {
        color: #666;
        font-size: 14px;
        margin: 0 0 10px 0;
        text-transform: uppercase;
        font-weight: 600;
      }
      
      .stat-card .value {
        font-size: 36px;
        font-weight: bold;
        margin: 0 0 10px 0;
      }
      
      .stat-card.high .value { color: #dc3545; }
      .stat-card.medium .value { color: #ffc107; }
      .stat-card.low .value { color: #28a745; }
      .stat-card.total .value { color: #17a2b8; }
      
      .stat-card .subtitle {
        color: #999;
        font-size: 12px;
        margin: 0;
      }
      
      .controls {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }
      
      .controls h3 {
        margin: 0;
        color: #333;
        min-width: 100px;
      }
      
      .filter-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      
      .filter-group label {
        font-size: 14px;
        color: #666;
        min-width: 80px;
      }
      
      .filter-group select, .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }
      
      table { 
        width: 100%; 
        border-collapse: collapse; 
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
      }
      
      th, td { 
        padding: 15px 12px; 
        text-align: left; 
        border-bottom: 1px solid #e5e7eb;
      }
      
      th { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        font-size: 14px;
      }
      
      tr:hover { background-color: #f8f9fa; }
      
      .muted { color: #6b7280; }
      
      .tag { 
        display: inline-block; 
        padding: 4px 12px; 
        border-radius: 20px; 
        font-size: 12px; 
        color: #fff; 
        font-weight: 600;
        text-transform: uppercase;
      }
      
      .tag-high { background: linear-gradient(135deg, #dc3545, #c82333); }
      .tag-medium { background: linear-gradient(135deg, #ffc107, #e0a800); }
      .tag-low { background: linear-gradient(135deg, #28a745, #1e7e34); }
      
      .loading {
        text-align: center;
        padding: 50px;
        color: #666;
        font-size: 16px;
      }
      
      .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .success {
        background-color: #d1ecf1;
        color: #0c5460;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .progress-bar {
        width: 100%;
        height: 4px;
        background-color: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 10px;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        width: 0%;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header Section -->
      <div class="header">
        <div>
          <h1>流失顧客預測分析</h1>
          <p class="subtitle">基於 RFM 分析和機器學習模型的智能流失風險評估</p>
        </div>
        <div>
          <button class="btn btn-success" onclick="exportData()">匯出報告CSV</button>
          <button class="btn btn-secondary" onclick="location.href='/index/'">返回首頁</button>
        </div>
      </div>

      <!-- Messages -->
      <div id="messageContainer"></div>

      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card total">
          <h3>總顧客數</h3>
          <div class="value" id="totalCustomers">0</div>
          <p class="subtitle">已分析的顧客總數</p>
        </div>
        
        <div class="stat-card high">
          <h3>高風險顧客</h3>
          <div class="value" id="highRiskCount">0</div>
          <p class="subtitle" id="highRiskPercent">流失機率 > 70%</p>
        </div>
        
        <div class="stat-card medium">
          <h3>中風險顧客</h3>
          <div class="value" id="mediumRiskCount">0</div>
          <p class="subtitle" id="mediumRiskPercent">流失機率 30-70%</p>
        </div>
        
        <div class="stat-card low">
          <h3>低風險顧客</h3>
          <div class="value" id="lowRiskCount">0</div>
          <p class="subtitle" id="lowRiskPercent">流失機率 < 30%</p>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <h3>篩選設定</h3>
        
        <div class="filter-group">
          <label>風險等級：</label>
          <select id="riskFilter">
            <option value="all">全部</option>
            <option value="high">高風險</option>
            <option value="medium">中風險</option>
            <option value="low">低風險</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>顯示筆數：</label>
          <input type="number" id="topK" value="20" min="1" max="100" />
        </div>
        
        <div class="filter-group">
          <label>最低機率：</label>
          <input type="number" id="minProbability" value="0" min="0" max="100" step="5" />
          <span style="font-size:12px; color:#666;">%</span>
        </div>
        
        <button class="btn btn-primary" onclick="applyFilters()">套用篩選</button>
        <button class="btn btn-secondary" onclick="resetFilters()">重設</button>
      </div>

      <!-- Data Table -->
      <div id="tableContainer">
        <table>
          <thead>
            <tr>
              <th>顧客ID</th>
              <th>最近購買 (天)</th>
              <th>購買頻率</th>
              <th>消費金額 (NT$)</th>
              <th>RFM分數</th>
              <th>流失機率</th>
              <th>風險等級</th>
              <th>建議行動</th>
            </tr>
          </thead>
          <tbody id="churnTable">
            <tr>
              <td colspan="8" class="loading">載入中...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Progress Bar -->
      <div id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
    </div>

    <script>
      let churnData = [];
      let filteredData = [];

      function showMessage(message, type = 'success') {
        const container = document.getElementById('messageContainer');
        container.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
          container.innerHTML = '';
        }, 5000);
      }

      function updateStatistics() {
        const total = churnData.length;
        const high = churnData.filter(c => c.risk_level === 'high').length;
        const medium = churnData.filter(c => c.risk_level === 'medium').length;
        const low = churnData.filter(c => c.risk_level === 'low').length;

        document.getElementById('totalCustomers').textContent = total;
        document.getElementById('highRiskCount').textContent = high;
        document.getElementById('mediumRiskCount').textContent = medium;
        document.getElementById('lowRiskCount').textContent = low;

        if (total > 0) {
          document.getElementById('highRiskPercent').textContent = `${((high/total)*100).toFixed(1)}% 的顧客`;
          document.getElementById('mediumRiskPercent').textContent = `${((medium/total)*100).toFixed(1)}% 的顧客`;
          document.getElementById('lowRiskPercent').textContent = `${((low/total)*100).toFixed(1)}% 的顧客`;
        }
      }

      function getRiskActions(riskLevel, probability) {
        switch(riskLevel) {
          case 'high':
            return probability > 0.85 ? '緊急挽留' : '積極關懷';
          case 'medium':
            return probability > 0.5 ? '優惠促銷' : '定期關懷';
          case 'low':
            return '維持關係';
          default:
            return '觀察';
        }
      }

      async function loadAndRender() {
        console.log("載入流失預測資料...");
        document.getElementById('churnTable').innerHTML = '<tr><td colspan="8" class="loading">載入中...</td></tr>';
        
        try {
          // 允許將頁面 query string 透傳給 API
          const params = new URLSearchParams(window.location.search);
          const res = await fetch('/churn/?' + params.toString());
          if (!res.ok) throw new Error('API 錯誤 ' + res.status);
          const body = await res.json();

          let rows = body.results || [];
          
          // 轉換資料格式為新的格式
          churnData = rows.map(r => ({
            customer_id: String(r.customerid),
            churn_probability: Number(r.probability),
            risk_level: r.risk_level,
            recency: Number(r.recency_days),
            frequency: Number(r.frequency),
            monetary: Number(r.monetary),
            rScore: Number(r.rScore),
            fScore: Number(r.fScore),
            mScore: Number(r.mScore)
          }));
          
          filteredData = [...churnData];
          updateStatistics();
          updateTable();
          
        } catch (error) {
          console.error("載入資料失敗:", error);
          showMessage("載入資料失敗: " + error.message, 'error');
          document.getElementById('churnTable').innerHTML = '<tr><td colspan="8" class="error">載入失敗</td></tr>';
        }
      }

      function applyFilters() {
        const riskFilter = document.getElementById('riskFilter').value;
        const topK = parseInt(document.getElementById('topK').value) || 20;
        const minProb = parseFloat(document.getElementById('minProbability').value) / 100 || 0;

        filteredData = churnData.filter(customer => {
          if (riskFilter !== 'all' && customer.risk_level !== riskFilter) return false;
          if (customer.churn_probability < minProb) return false;
          return true;
        });

        // 按流失機率排序
        filteredData.sort((a, b) => b.churn_probability - a.churn_probability);
        
        updateTable();
      }

      function updateTable() {
        const topK = parseInt(document.getElementById('topK').value) || 20;
        const tbody = document.getElementById('churnTable');
        tbody.innerHTML = "";

        const displayData = filteredData.slice(0, topK);

        if (displayData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="loading">沒有符合條件的資料</td></tr>';
          return;
        }

        displayData.forEach((customer) => {
          const row = document.createElement("tr");
          const rfmScore = `${customer.rScore || 0}-${customer.fScore || 0}-${customer.mScore || 0}`;
          const actions = getRiskActions(customer.risk_level, customer.churn_probability);
          
          row.innerHTML = `
            <td><strong>${customer.customer_id}</strong></td>
            <td>${customer.recency}</td>
            <td>${customer.frequency}</td>
            <td>${customer.monetary.toLocaleString()}</td>
            <td><code>${rfmScore}</code></td>
            <td><strong>${(customer.churn_probability * 100).toFixed(1)}%</strong></td>
            <td><span class="tag tag-${customer.risk_level}">${customer.risk_level}</span></td>
            <td><em>${actions}</em></td>
          `;
          tbody.appendChild(row);
        });
      }

      function resetFilters() {
        document.getElementById('riskFilter').value = 'all';
        document.getElementById('topK').value = '20';
        document.getElementById('minProbability').value = '0';
        filteredData = [...churnData];
        updateTable();
      }

      function trainModel() {
        const trainBtn = document.getElementById('trainText');
        const originalText = trainBtn.textContent;
        trainBtn.textContent = '訓練中...';
        
        document.getElementById('progressContainer').style.display = 'block';
        let progress = 0;
        
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress > 90) progress = 90;
          document.getElementById('progressFill').style.width = progress + '%';
        }, 500);

        fetch('/churn/train/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          clearInterval(progressInterval);
          document.getElementById('progressFill').style.width = '100%';
          
          setTimeout(() => {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
          }, 1000);
          
          if (data.status === 'success') {
            showMessage('模型訓練成功! ' + (data.message || ''), 'success');
            setTimeout(() => loadAndRender(), 1500);
          } else {
            showMessage('模型訓練失敗: ' + (data.message || '未知錯誤'), 'error');
          }
        })
        .catch(error => {
          clearInterval(progressInterval);
          document.getElementById('progressContainer').style.display = 'none';
          showMessage('訓練請求失敗: ' + error.message, 'error');
        })
        .finally(() => {
          trainBtn.textContent = originalText;
        });
      }

      function exportData() {
        const csvContent = [
          ['顧客ID', '最近購買天數', '購買頻率', '消費金額', '流失機率', '風險等級'],
          ...filteredData.map(c => [
            c.customer_id,
            c.recency,
            c.frequency,
            c.monetary,
            (c.churn_probability * 100).toFixed(2) + '%',
            c.risk_level
          ])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `churn_analysis_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showMessage('報告已匯出', 'success');
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // 事件監聽器
      document.getElementById('riskFilter').addEventListener('change', applyFilters);
      document.getElementById('topK').addEventListener('change', applyFilters);
      document.getElementById('minProbability').addEventListener('change', applyFilters);

      // 初始載入
      loadAndRender();
    </script>
  </body>
  </html>
