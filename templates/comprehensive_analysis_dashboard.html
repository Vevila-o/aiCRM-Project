<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶œåˆå®¢æˆ¶åˆ†æå„€è¡¨æ¿</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
        .analysis-section {
            background: white;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
        }
        .section-content {
            padding: 20px;
        }
        .risk-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .risk-high { background: #e74c3c; color: white; }
        .risk-medium { background: #f39c12; color: white; }
        .risk-low { background: #27ae60; color: white; }
        .customer-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .customer-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            background: #f8f9fa;
        }
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ğŸ¢ AI CRM ç¶œåˆå®¢æˆ¶åˆ†æå„€è¡¨æ¿</h1>
            <p>æœ€å¾Œæ›´æ–°æ™‚é–“: {{ analysis_data.analysis_time }}</p>
            <button class="refresh-btn" onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†æ•¸æ“š</button>
        </div>

        <!-- é—œéµæŒ‡æ¨™å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ total_customers }}</div>
                <div class="stat-label">ç¸½å®¢æˆ¶æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ consumption_stats.purchase_conversion_rate }}%</div>
                <div class="stat-label">è³¼è²·è½‰æ›ç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${{ consumption_stats.total_revenue|floatformat:0 }}</div>
                <div class="stat-label">ç¸½ç‡Ÿæ”¶</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ churn_summary.high_risk_count }}</div>
                <div class="stat-label">é«˜é¢¨éšªæµå¤±å®¢æˆ¶</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ consumption_stats.recent_activity_rate }}%</div>
                <div class="stat-label">è¿‘æœŸæ´»èºç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${{ consumption_stats.average_order_value|floatformat:0 }}</div>
                <div class="stat-label">å¹³å‡è¨‚å–®é‡‘é¡</div>
            </div>
        </div>

        <!-- RFM å®¢ç¾¤åˆ†ä½ˆ -->
        <div class="analysis-section">
            <div class="section-header">ğŸ“Š RFM å®¢ç¾¤åˆ†ä½ˆ</div>
            <div class="section-content">
                <div class="customer-list">
                    {% for label, count in analysis_data.rfm_analysis.distribution.labels|zip:analysis_data.rfm_analysis.distribution.counts %}
                    <div class="customer-card">
                        <strong>{{ label }}</strong>: {{ count }} äºº
                        <div style="margin-top: 5px;">
                            <div style="background: #3498db; height: 10px; width: {{ count|mul:100|div:total_customers }}%; border-radius: 5px;"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- æµå¤±é¢¨éšªåˆ†æ -->
        <div class="analysis-section">
            <div class="section-header">âš ï¸ æµå¤±é¢¨éšªåˆ†æ</div>
            <div class="section-content">
                <p><strong>åˆ†æå®¢æˆ¶æ•¸:</strong> {{ churn_summary.total_analyzed }} äºº</p>
                <p><strong>å¹³å‡æµå¤±æ©Ÿç‡:</strong> {{ churn_summary.average_churn_probability|mul:100|floatformat:1 }}%</p>
                
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-value" style="color: #e74c3c;">{{ churn_summary.high_risk_count }}</div>
                        <div class="stat-label">é«˜é¢¨éšªå®¢æˆ¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f39c12;">{{ churn_summary.medium_risk_count }}</div>
                        <div class="stat-label">ä¸­é¢¨éšªå®¢æˆ¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #27ae60;">{{ churn_summary.low_risk_count }}</div>
                        <div class="stat-label">ä½é¢¨éšªå®¢æˆ¶</div>
                    </div>
                </div>

                <h4>ğŸš¨ é«˜é¢¨éšªå®¢æˆ¶åˆ—è¡¨ (å‰10å)</h4>
                <div class="customer-list">
                    {% for customer in churn_summary.predictions|slice:":10" %}
                    {% if customer.risk_level == "high" %}
                    <div class="customer-card">
                        <strong>å®¢æˆ¶ ID: {{ customer.customerid }}</strong>
                        <br>æµå¤±æ©Ÿç‡: <span class="risk-{{ customer.risk_level }}">{{ customer.probability|mul:100|floatformat:1 }}%</span>
                        <br>RFMåˆ†æ•¸: R{{ customer.rScore }} F{{ customer.fScore }} M{{ customer.mScore }}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ä¸‹æ¬¡è³¼è²·é æ¸¬ -->
        {% if analysis_data.next_purchase_analysis.total_predictions > 0 %}
        <div class="analysis-section">
            <div class="section-header">ğŸ›’ ä¸‹æ¬¡è³¼è²·é æ¸¬</div>
            <div class="section-content">
                <p><strong>é æ¸¬å®¢æˆ¶æ•¸:</strong> {{ analysis_data.next_purchase_analysis.total_predictions }} äºº</p>
                <p><strong>å¹³å‡é æ¸¬å¤©æ•¸:</strong> {{ analysis_data.next_purchase_analysis.average_predicted_days }} å¤©</p>
                
                <h4>ğŸ¯ å³å°‡è³¼è²·å®¢æˆ¶ (7å¤©å…§)</h4>
                <div class="customer-list">
                    {% for customer in analysis_data.next_purchase_analysis.predictions %}
                    {% if customer.predicted_days <= 7 %}
                    <div class="customer-card">
                        <strong>å®¢æˆ¶ ID: {{ customer.customer_id }}</strong>
                        <br>é æ¸¬å¤©æ•¸: <span style="color: #27ae60; font-weight: bold;">{{ customer.predicted_days }} å¤©</span>
                        <br>æ­·å²å¹³å‡é–“éš”: {{ customer.avg_interval_history }} å¤©
                        <br>äº¤æ˜“æ¬¡æ•¸: {{ customer.total_transactions }}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- å®¢æˆ¶æˆé•·è¶¨å‹¢ -->
        <div class="analysis-section">
            <div class="section-header">ğŸ“ˆ å®¢æˆ¶æˆé•·è¶¨å‹¢</div>
            <div class="section-content">
                <div class="customer-list">
                    {% for label, growth, new_customers, total in growth_data.labels|zip:growth_data.growth_rates|zip:growth_data.new_customers|zip:growth_data.totals %}
                    <div class="customer-card">
                        <strong>{{ label }}</strong>
                        <br>æˆé•·ç‡: <span style="color: {% if growth > 0 %}#27ae60{% else %}#e74c3c{% endif %}; font-weight: bold;">{{ growth }}%</span>
                        <br>æ–°å®¢æˆ¶: {{ new_customers }} äºº
                        <br>ç´¯ç©ç¸½æ•¸: {{ total }} äºº
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- å®¢æˆ¶æ´»èºåº¦ -->
        <div class="analysis-section">
            <div class="section-header">ğŸ”¥ å®¢æˆ¶æ´»èºåº¦åˆ†æ</div>
            <div class="section-content">
                <div class="customer-list">
                    {% for label, rate, active, total in activity_data.labels|zip:activity_data.activity_rates|zip:activity_data.active_customers|zip:activity_data.total_customers %}
                    <div class="customer-card">
                        <strong>{{ label }}</strong>
                        <br>æ´»èºç‡: <span style="color: #3498db; font-weight: bold;">{{ rate }}%</span>
                        <br>æ´»èºå®¢æˆ¶: {{ active }} äºº
                        <br>ç¸½å®¢æˆ¶æ•¸: {{ total }} äºº
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- API ä½¿ç”¨èªªæ˜ -->
        <div class="analysis-section">
            <div class="section-header">ğŸ”— API ä½¿ç”¨èªªæ˜</div>
            <div class="section-content">
                <h4>ç²å–ç¶œåˆåˆ†ææ•¸æ“š:</h4>
                <code style="background: #f4f4f4; padding: 10px; display: block; margin: 10px 0;">
                    GET /api/comprehensive-analysis/?top_customers=20
                </code>
                
                <h4>ç²å–ç‰¹å®šå®¢ç¾¤åˆ†æ:</h4>
                <code style="background: #f4f4f4; padding: 10px; display: block; margin: 10px 0;">
                    GET /api/category-analysis/1/?top_customers=10
                </code>
                
                <p><strong>å¯ç”¨å®¢ç¾¤ID:</strong></p>
                <ul>
                    <li>1 - å¿ èª é¡§å®¢</li>
                    <li>2 - æ½›åœ¨é«˜åƒ¹å€¼é¡§å®¢</li>
                    <li>3 - æ™®é€šé¡§å®¢</li>
                    <li>4 - ä½åƒ¹å€¼é¡§å®¢</li>
                    <li>5 - æ²‰ç¡é¡§å®¢</li>
                    <li>6 - æ½›åœ¨æµå¤±é¡§å®¢</li>
                    <li>7 - æ–°é¡§å®¢</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // è‡ªå‹•é‡æ–°æ•´ç† (æ¯10åˆ†é˜)
        setTimeout(() => {
            location.reload();
        }, 600000);
        
        // æ·»åŠ ä¸€äº›äº’å‹•åŠŸèƒ½
        document.querySelectorAll('.customer-card').forEach(card => {
            card.addEventListener('click', function() {
                this.style.backgroundColor = this.style.backgroundColor === 'rgb(52, 152, 219)' ? '#f8f9fa' : '#3498db';
                this.style.color = this.style.color === 'white' ? '#333' : 'white';
            });
        });
    </script>
</body>
</html>